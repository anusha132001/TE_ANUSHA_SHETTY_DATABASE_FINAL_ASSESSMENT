/* Module 1: SQL Server:
1. Perform the normalization
	a) Create tables as per normalization
	b) Insert the data
	c) Join the table
	d) Create different views
Scenario:
1. Healthcare domain:
Multiple patients visiting hospitals located in multiple cities, for check up and treatment, multiple
doctors treating patients belong to specific department advising routine checkups(ex: Xray, Sugar
test, urine test, MRI etc) and further drugs(medicines) for the disease identified */

-----UN NORMALISED TABLE-------

CREATE TABLE TE_FA_Hospital_Management
(
Hos_id varchar(10),
Hos_Name varchar(30),
Hos_City varchar(20),

Phys_Id varchar(20),
Phys_Name varchar(20),
Phys_Dpt varchar(20),

Patnt_id varchar(10),
Patnt_Name varchar(20),
Patnt_Gender char,
Patnt_Med varchar(20),
Patnt_Phone bigint,
Patnt_City varchar(100)
)

----NORMALIZATION-


CREATE TABLE TE_FA_HOSPITALS
(
HSPT_ID VARCHAR(10) PRIMARY KEY,
HSPT_NAME VARCHAR(20),
HSPT_CITY VARCHAR(20)
)


CREATE TABLE TE_FA_PHYSICIANS
(
PHY_ID VARCHAR(10) PRIMARY KEY,
PHY_NAME VARCHAR(20),
PHY_SPECIALIZATION VARCHAR(20),
PHY_AGE INT,
HSPT_ID VARCHAR(10) 
FOREIGN KEY REFERENCES TE_FA_HOSPITALS(HSPT_ID)
ON DELETE SET NULL ON UPDATE SET NULL
)

CREATE TABLE TE_FA_PATIENTS
(
PAT_ID VARCHAR(10) PRIMARY KEY,
PAT_NAME VARCHAR(20),
PAT_AGE INT,
PAT_GENDER CHAR,
PAT_MEDICINE VARCHAR(20),
PAT_CHECKUP_TYPE VARCHAR(20),
PAT_PHONE BIGINT,
PAT_CITY VARCHAR(20),
DOC_ID VARCHAR(10) 
FOREIGN KEY REFERENCES TE_FA_PHYSICIANS(PHY_ID)
ON DELETE SET NULL ON UPDATE SET NULL
)

--INSERT TO HOSPITAL---
INSERT INTO TE_FA_HOSPITALS VALUES
('HS003','SPARSH HOSPITAL','BANGALORE'),
('HS004','SARJI HOSPITAL','SHIMOGA'),
('HS005','AJ HOSPITAL','MANGALORE'),
('HS001','APOLLO HOSPITAL','MYSORE')
('HS002','FATHER MULLERS','MANGALORE');

SELECT * FROM TE_FA_HOSPITALS;

---INSERT DATA TO PHYSICIANS---

INSERT INTO TE_FA_PHYSICIANS VALUES
('SH129','KRITHIKA L','ALLERGISTS','38','HS003'),
('AP102','REKHA SHEKAR','REGIONAL ANESTHESIA','38','HS001'),
('AP103','MARY DSOUZA','ALLERGISTS','33','HS001'),
('FM103','JAYA SHANKAR','PEDIATRICIANS','32','HS002'),
('FM104','JYOTHI P','DERMATOLOGISTS','37','HS002'),
('AJ105','MANASA R','ALLERGISTS','40','HS002'),
('AJ106','JAYESH','OPHTHALMOLOGISTS','45','HS002'),
('SH119','KRISHNA M','CARDIOLOGISTS','38','HS003'),
('SP118','HEENA','OPHTHALMOLOGISTS','45','HS004'),
('SP120','HARISH','NEPHROLOGISTS','44','HS004'),
('AP101','SANTOSH M','PHYSIOTHERAPY','35','HS001')



--INSERT DATA TO PATIENTS TABLE---

INSERT INTO TE_FA_PATIENTS VALUES
('P104','NAYANA',30,'F','FOSINOPRIL','CBC',5546267827,'MANGALORE','AJ105'),
('P103','NAVEEN',34,'M','BENAZEPRIL','X-RAY',6746267827,'MANGALORE','AJ105'),
('P105','SEETHA',33,'F','BENAZEPRIL','2D SCRENENIG',886267827,'UDUPI','AJ106'),
('P106','LAVITHA',43,'F','PERINDOPRIL','X-RAY',7886267827,'UDUPI','AJ105'),
('P101','RAHUL',41,'M','CETIRIZINE','BLOOD CHECKUP',8126267827,'MANGALORE','AJ105'),
('P110','AKASH',32,'M','PROPOFOL','SERUM CALCIUM',9236267827,'MYSORE','AP101'),
('P112','RAMYA',22,'F','CETIRIZINE','2D SCREENING',4526267827,'BANGALORE','AP103'),
('P113','MAYURI',32,'F','FEXOFENADINE','ECG',9426267827,'MYSORE','AP103'),
('P114','KAVYA',24,'F','FOSINOPRIL','CBC',9026267827,'BANGALORE','AP101'),
('P115','GIRISH',43,'M','CETIRIZINE','2D SCREENING',8026267827,'MANDYA','AP102'),
('P211','ABISHEK',32,'M','PROPOFOL','SERUM CALCIUM',9236267827,'MANGALORE','FM104'),
('P212','RACHANA',32,'F','CETIRIZINE','2D SCREENING',4526267827,'KARKALA','FM104'),
('P213','DIKSHITHA',31,'F','FEXOFENADINE','ECG',9426267827,'MANIPAL','FM104'),
('P214','NITHYA',26,'F','FOSINOPRIL','CBC',9026267827,'MANGALORE','FM104'),
('P215','DIONA V',43,'F','CETIRIZINE','2D SCREENING',8026267827,'MANIPAL','FM104'),
('P216','KEERTHI',12,'F','NUTRITION','ALBUTEROL',7836267827,'MANGALORE','FM103'),
('P217','MITHALI',08,'F','INFECTIONS','AMOXICILLIN',9846267827,'KARKALA','FM103'),
('P218','KIRAN',14,'M','NUTRITION','ALBUTEROL',9478267827,'MANIPAL','FM103'),
('P219','DIVESH',16,'M','ASTHMA','CEPHALEXIN',9026267827,'MANGALORE','FM103'),
('P220','JENNIFER',18,'F','ASTHMA','CEPHALEXIN',8026267867,'MANIPAL','FM103'),
('P311','ANKITHA',34,'F','PROPOFOL','SERUM CALCIUM',9236267866,'BANGALORE','SH129'),
('P312','BINDU',32,'F','CETIRIZINE','2D SCREENING',4526267856,'BANGALORE','SH129'),
('P313','KRUTHIK',31,'M','FEXOFENADINE','ECG',9426267866,'BANGALORE','FM104'),
('P314','NAVEEN',44,'M','FOSINOPRIL','CBC',9026267857,'MYSORE','SP118'),
('P315','KARAN',42,'M','CETIRIZINE','2D SCREENING',8026267457,'SHIMOGA','SP118'),
('P304','LAVANYA',30,'F','FOSINOPRIL','CBC',8946267827,'SHIMOGA','SP118'),
('P303','LEELA',34,'F','BENAZEPRIL','X-RAY',6778267827,'SHIMOGA','SP120'),
('P305','SEETHA',33,'F','BENAZEPRIL','2D SCRENENIG',866267827,'BANGALORE','SP120'),
('P306','LAVITHA',43,'F','PERINDOPRIL','X-RAY',7886264427,'UDUPI','SP120'),
('P301','RAHUL',41,'M','CETIRIZINE','BLOOD CHECKUP',8336267827,'SHIMOGA','SP118')


----RETRIVING RESULTS-----

SELECT * FROM TE_FA_HOSPITALS tfh 
SELECT * FROM TE_FA_PATIENTS tfp 
SELECT * FROM TE_FA_PHYSICIANS tfp2 


---Joins----

--INNER JOIN---

SELECT H.HSPT_ID, H.HSPT_NAME , P.PHY_ID, P.PHY_NAME, P.PHY_SPECIALIZATION, 
PA.PAT_ID, PA.PAT_NAME, PA.PAT_MEDICINE, PA.PAT_CHECKUP_TYPE FROM
TE_FA_HOSPITALS AS H 
INNER JOIN TE_FA_PHYSICIANS AS P 
ON H.HSPT_ID = P.HSPT_ID 
INNER JOIN TE_FA_PATIENTS PA 
ON P.PHY_ID = PA.DOC_ID ;

--LEFT JOIN AND RIGHT JOIN---

SELECT H.HSPT_ID, H.HSPT_NAME , P.PHY_ID, P.PHY_NAME, P.PHY_SPECIALIZATION, 
PA.PAT_ID, PA.PAT_NAME, PA.PAT_MEDICINE, PA.PAT_CHECKUP_TYPE FROM
TE_FA_HOSPITALS AS H 
LEFT JOIN TE_FA_PHYSICIANS AS P 
ON H.HSPT_ID = P.HSPT_ID 
RIGHT JOIN TE_FA_PATIENTS PA 
ON P.PHY_ID = PA.DOC_ID ;


SELECT H.HSPT_ID, H.HSPT_NAME , P.PHY_ID, P.PHY_NAME, P.PHY_SPECIALIZATION, 
PA.PAT_ID, PA.PAT_NAME, PA.PAT_MEDICINE, PA.PAT_CHECKUP_TYPE FROM
TE_FA_HOSPITALS AS H 
LEFT JOIN TE_FA_PHYSICIANS AS P 
ON H.HSPT_ID = P.HSPT_ID 
LEFT JOIN TE_FA_PATIENTS PA 
ON P.PHY_ID = PA.DOC_ID ;


---FULL JOIN----
SELECT H.HSPT_ID, H.HSPT_NAME , P.PHY_ID, P.PHY_NAME, P.PHY_SPECIALIZATION, 
PA.PAT_ID, PA.PAT_NAME, PA.PAT_MEDICINE, PA.PAT_CHECKUP_TYPE FROM
TE_FA_HOSPITALS AS H 
FULL JOIN TE_FA_PHYSICIANS AS P 
ON H.HSPT_ID = P.HSPT_ID 
FULL JOIN TE_FA_PATIENTS PA 
ON P.PHY_ID = PA.DOC_ID ;


------VIEWS------

---VIEW BASED ON JOINS---

CREATE VIEW TE_FA_HOSPITAL_PHISISIANS
AS 
SELECT H.HSPT_ID, H.HSPT_NAME , P.PHY_ID, P.PHY_NAME, P.PHY_SPECIALIZATION
FROM TE_FA_HOSPITALS AS H 
LEFT JOIN TE_FA_PHYSICIANS AS P 
ON H.HSPT_ID = P.HSPT_ID 

SELECT * FROM TE_FA_HOSPITAL_PHISISIANS

----VIEW BASED ON CONDITION--

CREATE VIEW TE_FA_PATIENTS_VIEW AS
SELECT PAT_ID,PAT_NAME,PAT_AGE,PAT_MEDICINE,PAT_CHECKUP_TYPE, PAT_CITY,DOC_ID
FROM TE_FA_PATIENTS WHERE PAT_AGE>=33;

SELECT * FROM TE_FA_PATIENTS_VIEW

---VIEW ON PATIENT AND HOSPITALS WITH SAME CITY---
CREATE VIEW TE_FA_PATIENT_HOSPITALS
AS
SELECT P.PAT_ID, P.PAT_NAME,P.PAT_MEDICINE,
H.HSPT_ID, H.HSPT_NAME,H.HSPT_CITY AS CITY
FROM TE_FA_PATIENTS AS P, TE_FA_HOSPITALS AS H
WHERE P.PAT_CITY = H.HSPT_CITY ;

SELECT * FROM TE_FA_PATIENT_HOSPITALS


----DDL , DML, DCL--------

---Cinema data source------
--- DDL--CREATE,DROP, ALTER, TRUNCATE----
CREATE TABLE TE_FA_CINEMA
(
FILM_TYPE VARCHAR(20),
FILM_CODE INT,
CINEMA_CODE INT,
TOTAL_SALES BIGINT,
TICKETS_SOLD INT,
TICKETS_OUT INT,
SHOW_TIME INT,
OCCU_PERC FLOAT,
TICKET_PRICE FLOAT,
TICKET_USE INT,
CAPACITY INT,
DATE DATE
)

---DML--INSERT,SELECT,DELETE, UPDATE---

INSERT INTO TE_FA_CINEMA VALUES
('Romance',1492,304,16500000,112,0,4,18.33,147321.4286,112,611,'04/05/2018'),
('Romance',1492,352,13950000,93,0,5,10.57,150000,93,880,'04/05/2018'),
('Romance',1492,344,10200000,68,0,3,8.54,150000,68,796,'04/05/2018'),
('Romance',1492,344,300000,2,0,3,0.25,150000,2,800,'05/05/2018'),
('Romance',1492,73,240000,2,0,1,2.04,120000,2,98,'05/05/2018'),

('Thriller',1486,82,880000,11,0,6,0.62,80000,11,1774,'03/16/2018'),
('Thriller',1486,262,640000,8,0,3,1.68,80000,8,476,'03/16/2018'),
('Thriller',1486,50,400000,4,0,3,1.36,100000,4,294,'03/16/2018'),
('Thriller',1486,448,73940000,620,0,7,45.19,119258.0645,620,1372,'03/16/2018'),

('Drama',1471,492,780000,13,0,1,6.25,60000,13,208,'06/28/2018'),
('Drama',1471,509,500000,10,0,1,3.89,50000,10,257,'06/28/2018'),
('Drama',1471,448,4800000,32,0,1,16.33,150000,32,196,'06/27/2018'),
('Drama',1471,492,480000,8,0,1,3.85,60000,8,208,'06/27/2018'),
('Comedy',1480,380,200000,2,0,1,2.86,100000,2,70,'04/27/2018'),
('Comedy',1480,448,40639998,271,0,4,35.66,149963.0923,271,760,'04/26/2018'),
('Horror',1484,509,250000,5,0,1,1.95,50000,5,256,'04/15/2018'),
('Horror',1484,448,421506996,2835,0,15,80.84,148679.7164,2835,3507,'04/14/2018'),
('Horror',1484,304,183750000,1242,0,8,90.52,147946.8599,1242,1372,'04/14/2018'),
('Horror',1484,517,250000,5,0,1,3.29,50000,5,152,'04/15/2018'),
('Family',1483,196,17840000,245,0,4,49,72816.32653,245,500,'04/01/2018'),
('Family',1483,152,16920000,424,0,2,94.64,39905.66038,424,448,'04/01/2018');

SELECT * FROM TE_FA_CINEMA;

---ALTER---

ALTER TABLE TE_FA_CINEMA DROP COLUMN DATE;

--UPDATE --
UPDATE TE_FA_CINEMA SET FILM_CODE=1493 WHERE FILM_TYPE ='ROMANCE';

SELECT * FROM TE_FA_CINEMA;

---DELETE --
DELETE FROM TE_FA_CINEMA WHERE CINEMA_CODE =304;

---TRUNCATE ---
TRUNCATE TABLE TE_FA_CINEMA 

SELECT * FROM TE_FA_CINEMA tfc 

---DROP--
DROP TABLE TE_FA_CINEMA 

---IN OPERATOR----

SELECT FILM_CODE ,FILM_TYPE ,TOTAL_SALES,TICKETS_SOLD,TICKETS_OUT ,TICKET_PRICE
FROM TE_FA_CINEMA WHERE FILM_CODE IN(1492,1471);

---BETWEEN OPERATOR----
SELECT FILM_TYPE ,TOTAL_SALES,TICKETS_SOLD,TICKETS_OUT ,TICKET_PRICE
FROM TE_FA_CINEMA WHERE TICKET_PRICE BETWEEN 50000 AND 100000;


---AGGREGATE FUNCTIONS---
SELECT SUM(TOTAL_SALES)AS SUM_SALES, FILM_TYPE FROM TE_FA_CINEMA
GROUP BY FILM_TYPE;

SELECT MAX(TICKET_PRICE) AS MAX_PRICE,FILM_TYPE FROM TE_FA_CINEMA
GROUP BY FILM_TYPE

SELECT AVG(TICKET_USE) AS AVG_TICKET,FILM_CODE FROM TE_FA_CINEMA
GROUP BY FILM_CODE

---RANK FUNCTION--
SELECT DENSE_RANK() OVER (PARTITION BY FILM_TYPE ORDER BY TICKETS_SOLD DESC)
AS DRANK,FILM_TYPE ,TICKETS_SOLD  FROM TE_FA_CINEMA;

---HOSPITAL DATA SOURCE--
---CREATE TABLE---										
CREATE TABLE TE_FA_HEALTH_INS
(
PID INT,
AGE INT,
GENDER VARCHAR(10),
CASTE VARCHAR(20),
CATEGORY_CODE VARCHAR(10),
CATEGORY_NAME VARCHAR(50),
SURGERY_CODE VARCHAR(20),
SURGERY VARCHAR(100),
VILLAGE VARCHAR(20),
MANDAL_NAME VARCHAR(20),
DISTRICT VARCHAR(20),
PREAUTH_AMT BIGINT
)
----INSERT----

INSERT INTO TE_FA_HEALTH_INS VALUES
(1,56,'Female','BC','M6','NEPHROLOGY','M6.5','Maintenance Hemodialysis For Crf','Lolugu','Ponduru','Srikakulam',12500),
(2,37,'Male','BC','M6','NEPHROLOGY','M6.5','Maintenance Hemodialysis For Crf','Borivanka','Kaviti','Srikakulam',12500),
(3,50,'Male','BC','M6','NEPHROLOGY','M6.5','Maintenance Hemodialysis For Crf','Kapasakuddi','Kaviti','Srikakulam',12500),
(4,45,'Male','BC','M6','NEPHROLOGY','M6.5','Maintenance Hemodialysis For Crf','Telikipenta','Sarubujjili','Srikakulam',12500),
(10,49,'Male','OC','S7','CARDIAC AND CARDIOTHORACIC SURGERY','S7.2.1.1','Coronary Bypass Surgery','Ward-15','Guntur(C)','Guntur',115846),
(11,52,'Male','BC','M6','NEPHROLOGY','M6.5','Maintenance Hemodialysis For Crf','Rajam','Butchayyapeta','Vishakhapatnam',12500),
(12,56,'Male','SC','M5','CARDIOLOGY','M5.1.2','Management Of Acute MI With Angiogram','Thurlapadu','Edlapadu','Guntur',30000),
(13,65,'Female','SC','M5','CARDIOLOGY','M5.1.5','Medical Management of  Refractory Cardiac Failure','Pulipadu','Gurazala','Guntur',40000),
(14,75,'Male','OC','M5','CARDIOLOGY','M5.1.5','Medical Management of  Refractory Cardiac Failure','Karlapalem','Karlapalem','Guntur',40000),
(20,57,'Female','OC','M5','CARDIOLOGY','M5.1.2','Management Of Acute MI With Angiogram','Phirangipuram','Phirangipuram','Guntur',30000),
(21,55,'Male','OC','M6','NEPHROLOGY','M6.5','Maintenance Hemodialysis For Crf Ayyavari','Polavaram','Jangareddigudem','West Godavari',12500),
(22,74,'Female','BC','M5','CARDIOLOGY','M5.1.2','Management Of Acute MI With Angiogram 4th Ward','Palasa','Kasibugga','Srikakulam',30000),
(23,57,'Male','BC','M5','CARDIOLOGY','M5.1.2','Management Of Acute MI With Angiogram','Kambakaya','Narasannapeta','Srikakulam',30000),
(24,56,'Male','BC','S7','CARDIAC AND CARDIOTHORACIC SURGERY','S7.2.1.1','Coronary Bypass Surgery','Konduru','Achampeta','Guntur',115846),
(25,31,'Male','BC','S5','ORTHOPEDIC  SURGERY AND PROCEDURES','S5.1.2','Excision Or Other Operations For Scaphoid Fractures','Laxmipuram','Mandasa','Srikakulam',15000),
(26,68,'Male','BC','M5','CARDIOLOGY','M5.1.2','Management Of Acute MI With Angiogram','Matchalesam','Gara','Srikakulam',30000),
(27,72,'Female','BC','M5','CARDIOLOGY','M5.1.2','Management Of Acute MI With Angiogram','Meghavaram','Santhabommali','Srikakulam',30000),
(28,66,'Female','OC','M5','CARDIOLOGY','M5.1.2','Management Of Acute MI With Angiogram','Chavali','Vemuru','Guntur',30000),
(29,35,'Male','BC','M5','CARDIOLOGY','M5.1.2','Management Of Acute MI With Angiogram','Shermahammadpuram','Etcherla','Srikakulam',30000),
(30,72,'Female','SC','M5','CARDIOLOGY','M5.1.2','Management Of Acute MI With Angiogram','Talagam','Tekkali','Srikakulam',30000);

SELECT * FROM TE_FA_HEALTH_INS 

----COUNT----
SELECT GENDER,COUNT(PID) FROM TE_FA_HEALTH_INS
GROUP BY GENDER;

---STRING FUNCTION--

SELECT PID,SURGERY,CONCAT(CATEGORY_CODE,'-',CATEGORY_NAME) AS CATEGORY, DISTRICT 
FROM TE_FA_HEALTH_INS 


---ALTER---
ALTER TABLE TE_FA_HEALTH_INS DROP COLUMN VILLAGE;

---UPDATE --
UPDATE TE_FA_HEALTH_INS SET CATEGORY_CODE='M11' WHERE CATEGORY_NAME='NEPHROLOGY';


---DELETE ---
DELETE FROM TE_FA_HEALTH_INS WHERE PID=1;


---TRUNCATE--
TRUNCATE TABLE TE_FA_HEALTH_INS

----DROP----
DROP TABLE TE_FA_HEALTH_INS

SELECT * FROM TE_FA_HEALTH_INS 

